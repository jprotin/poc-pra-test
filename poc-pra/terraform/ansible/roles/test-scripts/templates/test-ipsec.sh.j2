#!/bin/bash
# {{ ansible_managed }}
# Script de test de connectivité IPsec vers Azure

echo "=========================================="
echo "Test de connectivité IPsec vers Azure"
echo "=========================================="
echo ""

# Couleurs
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Variables
AZURE_VNET_CIDR="{{ azure_vnet_cidr }}"
AZURE_TARGET_IP="{{ azure_vnet_cidr | regex_replace('/.*', '') | regex_replace('0.0$', '0.4') }}"

echo "Configuration:"
echo "  Azure VNet: $AZURE_VNET_CIDR"
echo "  Target IP: $AZURE_TARGET_IP"
echo ""

echo "1. Vérification du statut IPsec"
echo "--------------------------------"
ipsec status
echo ""

echo "2. Vérification des tunnels actifs"
echo "-----------------------------------"
ip xfrm policy
echo ""

echo "3. Test ICMP (Ping) vers Azure"
echo "-------------------------------"
if ping -c 4 -W 2 "$AZURE_TARGET_IP" > /dev/null 2>&1; then
  echo -e "${GREEN}✓ Ping réussi vers $AZURE_TARGET_IP${NC}"
else
  echo -e "${RED}✗ Ping échoué vers $AZURE_TARGET_IP${NC}"
fi
echo ""

echo "4. Test TCP vers Azure (ports communs)"
echo "---------------------------------------"
for PORT in 80 443 3389 1433 5432; do
  if timeout 2 bash -c "echo > /dev/tcp/$AZURE_TARGET_IP/$PORT" 2>/dev/null; then
    echo -e "${GREEN}✓ TCP/$PORT: Success${NC}"
  else
    echo -e "${RED}✗ TCP/$PORT: Failed${NC}"
  fi
done
echo ""

echo "5. Test UDP avec Netcat"
echo "-----------------------"
for PORT in 53 123 161 514 8080; do
  echo "UDP test" | nc -u -w 1 "$AZURE_TARGET_IP" "$PORT" 2>/dev/null
  echo -e "${YELLOW}⚠ UDP/$PORT: Packet sent${NC}"
done
echo ""

echo "6. Statistiques IPsec"
echo "---------------------"
ipsec statusall | grep -E "INSTALLED|bytes"
echo ""

echo "7. Capture de paquets (5 secondes)"
echo "-----------------------------------"
echo "Démarrage de tcpdump sur esp/udp 500/4500..."
timeout 5 tcpdump -i any -n '(esp or udp port 500 or udp port 4500)' -c 20 2>&1 | tail -10
echo ""

echo "=========================================="
echo "Test terminé"
echo "=========================================="
echo ""
echo "Commandes utiles:"
echo "  - Logs IPsec: sudo journalctl -u strongswan -f"
echo "  - Restart IPsec: sudo ipsec restart"
echo "  - Status détaillé: sudo ipsec statusall"
echo "  - Voir les SAs: sudo ip xfrm state"
