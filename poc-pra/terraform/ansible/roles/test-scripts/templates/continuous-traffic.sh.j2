#!/bin/bash
# {{ ansible_managed }}
# Script pour générer du trafic continu vers Azure

AZURE_TARGET_IP="{{ azure_vnet_cidr | regex_replace('/.*', '') | regex_replace('0.0$', '0.4') }}"
INTERVAL=5

echo "Génération de trafic continu vers $AZURE_TARGET_IP"
echo "Appuyez sur Ctrl+C pour arrêter"
echo ""

while true; do
  echo "[$(date)] Envoi de paquets..."
  
  # ICMP
  ping -c 1 -W 1 "$AZURE_TARGET_IP" > /dev/null 2>&1 && \
    echo "  ✓ ICMP" || echo "  ✗ ICMP"
  
  # TCP
  timeout 1 bash -c "echo > /dev/tcp/$AZURE_TARGET_IP/443" 2>/dev/null && \
    echo "  ✓ TCP/443" || echo "  ✗ TCP/443"
  
  # UDP
  echo "UDP test" | nc -u -w 1 "$AZURE_TARGET_IP" 8080 2>/dev/null
  echo "  ⚠ UDP/8080 sent"
  
  sleep "$INTERVAL"
done
