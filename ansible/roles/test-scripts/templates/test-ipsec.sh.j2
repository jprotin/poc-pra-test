#!/bin/bash
# ==============================================================================
# Script de test du tunnel IPsec
# ==============================================================================

set -e

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "======================================================================"
echo "  Test du tunnel IPsec vers Azure"
echo "======================================================================"
echo ""

# Test 1 : Statut du tunnel
echo -n "Test 1 - Statut du tunnel IPsec : "
if ipsec status azure-tunnel | grep -q "ESTABLISHED"; then
    echo -e "${GREEN}UP ✅${NC}"
else
    echo -e "${RED}DOWN ❌${NC}"
    exit 1
fi

# Test 2 : Ping vers le réseau Azure
echo -n "Test 2 - Ping vers Azure ({{ azure_vnet_cidr | regex_replace('/.*', '.10') }}) : "
if ping -c 3 -W 2 {{ azure_vnet_cidr | regex_replace('/.*', '.10') }} > /dev/null 2>&1; then
    echo -e "${GREEN}OK ✅${NC}"
else
    echo -e "${YELLOW}Pas de réponse (normal si aucune VM dans Azure)${NC}"
fi

# Test 3 : Vérifier les SAs
echo ""
echo "Security Associations actives :"
ipsec statusall | grep -A 5 "azure-tunnel"

echo ""
echo "======================================================================"
echo -e "${GREEN}Tests terminés avec succès !${NC}"
echo "======================================================================"
