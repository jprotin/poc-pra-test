---
# ==============================================================================
# Playbook Ansible - Configuration complÃ¨te infrastructure OVH
# ==============================================================================
# Description : Configuration post-dÃ©ploiement de toutes les VMs
#               (Docker + MySQL) dÃ©ployÃ©es via Terraform
# Usage       : ansible-playbook -i inventory.yml configure-all.yml
# ==============================================================================

- name: "ğŸ“‹ Configuration complÃ¨te de l'infrastructure OVH VMware"
  hosts: all
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: "ğŸ” Afficher informations de l'hÃ´te"
      debug:
        msg: "Configuration de {{ inventory_hostname }} ({{ ansible_host }}) - Role: {{ role }}"

    - name: "â³ Attendre que cloud-init soit terminÃ©"
      command: cloud-init status --wait
      changed_when: false
      timeout: 600

  tasks:
    - name: "âœ… VÃ©rifier connectivitÃ© Internet"
      uri:
        url: https://www.google.com
        timeout: 10
      register: internet_check
      failed_when: false

    - name: "ğŸ“Š Afficher statut connectivitÃ©"
      debug:
        msg: "ConnectivitÃ© Internet: {{ 'OK' if internet_check.status == 200 else 'FAILED' }}"

# ==============================================================================
# Configuration spÃ©cifique VMs Docker
# ==============================================================================

- name: "ğŸ³ Configuration VMs Docker"
  hosts: docker_vms
  become: yes

  tasks:
    - name: "ğŸ” VÃ©rifier installation Docker"
      command: docker --version
      register: docker_version_output
      changed_when: false

    - name: "ğŸ“Š Afficher version Docker"
      debug:
        msg: "{{ docker_version_output.stdout }}"

    - name: "ğŸ” VÃ©rifier installation Docker Compose"
      command: docker-compose --version
      register: docker_compose_version_output
      changed_when: false

    - name: "ğŸ“Š Afficher version Docker Compose"
      debug:
        msg: "{{ docker_compose_version_output.stdout }}"

    - name: "ğŸ§ª Tester Docker avec conteneur hello-world"
      docker_container:
        name: test-hello-world
        image: hello-world
        state: started
        auto_remove: yes
      register: docker_test

    - name: "âœ… Docker opÃ©rationnel"
      debug:
        msg: "Docker est correctement configurÃ© et fonctionnel"

# ==============================================================================
# Configuration spÃ©cifique VMs MySQL
# ==============================================================================

- name: "ğŸ¬ Configuration VMs MySQL"
  hosts: mysql_vms
  become: yes

  tasks:
    - name: "ğŸ” VÃ©rifier service MySQL"
      systemd:
        name: mysql
        state: started
        enabled: yes

    - name: "ğŸ“Š Afficher statut MySQL"
      command: systemctl status mysql --no-pager
      register: mysql_status
      changed_when: false

    - name: "ğŸ” VÃ©rifier version MySQL"
      command: mysql --version
      register: mysql_version_output
      changed_when: false

    - name: "ğŸ“Š Afficher version MySQL"
      debug:
        msg: "{{ mysql_version_output.stdout }}"

    - name: "ğŸ§ª Tester connexion MySQL locale"
      command: mysql -u root -e "SELECT VERSION();"
      register: mysql_test
      changed_when: false

    - name: "âœ… MySQL opÃ©rationnel"
      debug:
        msg: "MySQL est correctement configurÃ© et fonctionnel"

# ==============================================================================
# Tests de connectivitÃ© inter-VMs
# ==============================================================================

- name: "ğŸ”— Tests de connectivitÃ© Docker â†’ MySQL"
  hosts: docker_vms
  become: no

  vars:
    mysql_ip_rbx: "{{ hostvars['mysql-rbx']['ansible_host'] }}"
    mysql_ip_sbg: "{{ hostvars['mysql-sbg']['ansible_host'] }}"

  tasks:
    - name: "ğŸ” Test ping vers MySQL (mÃªme site)"
      ping:
        data: ping
      delegate_to: "{{ 'mysql-rbx' if site == 'rbx' else 'mysql-sbg' }}"

    - name: "ğŸ” Test connexion MySQL port 3306 (mÃªme site)"
      wait_for:
        host: "{{ mysql_ip_rbx if site == 'rbx' else mysql_ip_sbg }}"
        port: 3306
        timeout: 10
      register: mysql_port_check

    - name: "âœ… ConnectivitÃ© MySQL OK"
      debug:
        msg: "Connexion au serveur MySQL {{ mysql_ip_rbx if site == 'rbx' else mysql_ip_sbg }} rÃ©ussie"

# ==============================================================================
# RÃ©sumÃ© final
# ==============================================================================

- name: "ğŸ“Š RÃ©sumÃ© de la configuration"
  hosts: localhost
  gather_facts: no

  tasks:
    - name: "âœ… Configuration terminÃ©e avec succÃ¨s"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  Configuration de l'infrastructure OVH terminÃ©e avec succÃ¨s  â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  âœ… VMs Docker configurÃ©es et opÃ©rationnelles                 â•‘
          â•‘  âœ… VMs MySQL configurÃ©es et opÃ©rationnelles                  â•‘
          â•‘  âœ… ConnectivitÃ© rÃ©seau vÃ©rifiÃ©e                              â•‘
          â•‘                                                               â•‘
          â•‘  Prochaines Ã©tapes :                                          â•‘
          â•‘  1. DÃ©ployer applications via docker-compose                  â•‘
          â•‘  2. Configurer Zerto VPG (via Terraform)                      â•‘
          â•‘  3. Tester failover RBX â†’ SBG                                 â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
